(function(){$.msgBox=function(title,msg,callback){if(msg&&typeof msg==="function"){callback=msg;}
GenerateHtml(title,msg);btnOk(callback);btnNo();};$.msgBox.mini=function(txt,time,callback){var str="<div id='msgBoxMini'></div>";$('body').append(str);var msgBoxMini=$('#msgBoxMini'),_time=1400;if(time&&typeof time=='number')_time=time;msgBoxMini.css({'min-height':'18px','min-width':'100px','position':'fixed','left':'50%','top':'50%','z-index':'9999','font-size':'16px','padding':'40px 50px','border-radius':'4px','box-shadow':'0px 0px 12px 2px #aaa','background':'rgba(121,208,206,.9)','color':'#fff','border':'3px solid #f9f9f9','text-align':'center'});var _w=msgBoxMini.outerWidth(true),_h=msgBoxMini.outerHeight(true);msgBoxMini.css({'margin-left':-_w/2,'margin-top':-_h/2});this.show=(function(){msgBoxMini.text(txt);msgBoxMini.show();setTimeout(function(){msgBoxMini.fadeOut(function(){msgBoxMini.remove();if(typeof time=='function'){time();}else if(typeof callback=='function'){callback();}});},_time);})();};var GenerateHtml=function(title,msg){var _html="";_html+='<div id="mb_box"></div><div id="mb_con"><span id="mb_tit">'+title+'</span>';if(msg&&typeof msg!=="function"){_html+='<div id="mb_msg">'+msg+'</div>';}else{_html+='<textarea style="resize:none;" placeholder="请输入信息" id="mb_text" row="3"></textarea>';}
_html+='<div id="mb_btnbox">';if(msg&&typeof msg=="function"){_html+='<input id="mb_btn_no" type="button" value="取消" />';}
_html+='<input id="mb_btn_ok" type="button" value="确定" />';_html+='</div></div>';$("body").append(_html);GenerateCss();};var GenerateCss=function(){$("#mb_box").css({width:'100%',height:'100%',zIndex:'99999',position:'fixed',filter:'Alpha(opacity=60)',backgroundColor:'black',top:'0',left:'0',opacity:'0.6'});$("#mb_con").css({zIndex:'999999',width:'340px',position:'fixed',backgroundColor:'White',borderRadius:'10px'});$("#mb_tit").css({display:'block',fontSize:'14px',color:'#444',padding:'10px 15px',backgroundColor:'#DDD',borderRadius:'10px 10px 0 0',borderBottom:'3px solid #009BFE',fontWeight:'bold'});$("#mb_msg").css({padding:'40px 20px',lineHeight:'20px',color:"#444",borderBottom:'1px dashed #DDD',fontSize:'13px',textAlign:'center'});$("#mb_text").css({padding:'10px',lineHeight:'20px',color:"#444",height:'60px',width:'250px',margin:"10px 35px",border:'none',fontSize:'14px',outline:'none',overflow:'auto',borderBottom:'1px dashed #DDD'});$("#mb_btnbox").css({margin:'15px 0 10px 0',textAlign:'center'});$("#mb_btn_ok,#mb_btn_no").css({width:'85px',height:'30px',color:'white',border:'none',backgroundColor:'#168bbb',cursor:'pointer'});$("#mb_btn_no").css({"marginRight":"30px",background:"#ddd",color:"#666"});var _widht=document.documentElement.clientWidth;var _height=document.documentElement.clientHeight;var boxWidth=$("#mb_con").width();var boxHeight=$("#mb_con").height();$("#mb_con").css({top:(_height-boxHeight)/2+"px",left:(_widht-boxWidth)/2+"px"});};var btnOk=function(callback){$("#mb_btn_ok").on('click',function(){_msgTxt=$("#mb_text").val();$("#mb_box,#mb_con").remove();if(typeof(callback)==='function'){callback();}
return _msgTxt;});};var btnNo=function(){$("#mb_btn_no").on('click',function(){$("#mb_box,#mb_con").remove();return false;});};})();$(function(){var cart_head_all=$('.cart-head-all'),cart_foot_all=$('.cart-foot-all'),cart_checkbox=$('.cart-checkbox'),cart_pay_num=$('.cart-pay-num'),cart_download_num=$('.cart-download-num'),cart_total=$('.cart-total'),toPay=$('.toPay'),toOneDown=$('.cart-down-btn'),toAllDown=$('.toDownload'),del_btn=$('.del-btn'),mark_btn=$('.mark-btn'),_method='alipay';goods_list=[];var bill_id;var file_download_url='http://192.168.1.101:8888/file/download/';cart_head_all.on('click',function(){if(this.checked){cart_checkbox.each(function(){this.checked=true;});document.getElementsByClassName('cart-foot-all')[0].checked=true;}else{cart_checkbox.each(function(){this.checked=false;});document.getElementsByClassName('cart-foot-all')[0].checked=false;}
setAccount();setNum();goods_list=[];setGoodsId();});cart_foot_all.on('click',function(){if(this.checked){cart_checkbox.each(function(){this.checked=true;});document.getElementsByClassName('cart-head-all')[0].checked=true;}else{cart_checkbox.each(function(){this.checked=false;});document.getElementsByClassName('cart-head-all')[0].checked=false;}
setAccount();setNum();goods_list=[];setGoodsId();});cart_checkbox.on('click',function(){setAccount();setNum();goods_list=[];setGoodsId();});function setAccount(){var account=0;cart_checkbox.each(function(){var _this=$(this);if(this.checked){var _aPrice=_this.parents('.cart-layout').find('.cart-price');account+=parseInt(_aPrice.text());}});cart_total.text('￥'+account);}
function setNum(){var num=0;cart_checkbox.each(function(){if(this.checked){num+=1;}});cart_pay_num.text(num);cart_download_num.text(num);}
function setGoodsId(){cart_checkbox.each(function(){var _this=$(this);if(this.checked){var _this=$(this),_parent=_this.parents('.cart-box'),goods_id=_parent.attr('data-id');goods_list.push(goods_id);}});}
del_btn.on('click',function(){var _this=$(this),_parent=_this.parents('.cart-box'),goods_id=_parent.attr('data-id');$.post('/payment/del_cart',{'goods_id':goods_id},function(e){result=JSON.parse(e);if(result['status']=='TRUE'){_parent.remove();}
if(result['cart_is_exist']=='FALSE'){var str="<p class='pl20 h200'>您购物车暂时还没有任何商品，<a class='ml10' style='color:#54c5d0' href='/shop'>马上去挑 >></a></p>";var contBox=_this.parents('.cart-cont');contBox.html('').append(str);}});});mark_btn.on('click',function(){var _this=$(this),goods_id=_this.parents('.cart-box').attr('data-id');$.post('/payment/cart/mark',{'goods_id':goods_id},function(e){if(e){$.msgBox.mini('收藏成功');}});});toOneDown.on('click',function(){var _this=$(this),goods_id=_this.parents('.cart-box').attr('data-id');var url;goods_list.push(goods_id);$.post('/designer/file_download',{'goods_list':goods_list},function(e){result=JSON.parse(e);glist=result['glist'];for(var r in glist){md5=glist[r]['md5'];zip_name=glist[r]['zip_name'];url=file_download_url+md5+'/'+zip_name;var obj=document.getElementById('download');obj.contentWindow.location.href=url;}});});toAllDown.on('click',function(){var url;$.post('/designer/file_download',{'goods_list':goods_list},function(e){result=JSON.parse(e);glist=result['glist'];for(var r in glist){md5=glist[r]['md5'];zip_name=glist[r]['zip_name'];url=file_download_url+md5+'/'+zip_name;var obj=document.getElementById('download'+r);obj.contentWindow.location.href=url;}});});toPay.on('click',function(){if(goods_list.length==0){$.msgBox.mini('请选择购买商品');}else{$('.cart-method-wrap').removeClass('hide');$.post('/payment/build_bills',{'goods_list':goods_list,'where':'cart'},function(e){result=JSON.parse(e);if(result['status']=='SUCCESS'){bill_id=result['bill_id'];}else{$.msgBox.mini('生成订单失败，请重新操作');}});}});$('.cart-method-wrap').on('click',function(){$(this).addClass('hide');});$('.cart-method-box').on('click',function(e){e.stopPropagation();});$('.method-box a').on('click',function(){var _this=$(this);_this.siblings().removeClass('active');_this.addClass('active');if(_this.hasClass('alipay')){_method='alipay';}else{_method='tenpay';}});$('.gopay').on('click',function(){$.post('/payment/pay',{'bills_id':bill_id,'pay_method':_method},function(e){var url=JSON.parse(e)['state'];gotoUrl(url);});});function gotoUrl(url){var gotoLink=document.createElement('a');gotoLink.href=url;document.body.appendChild(gotoLink);gotoLink.click();};});